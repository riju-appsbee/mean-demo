if("undefined"!=typeof module&&"undefined"!=typeof process)var RSVP=require("RSVP");var GeoFire=function(){"use strict";var e=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("callback must be a function");var n=e},n=function(e){function n(e,n){return new RSVP.Promise(function(r,i){u.child("l/"+e).once("value",function(o){var a=o.val();null===a?r(null!==n):null!==n&&n[0]===a[0]&&n[1]===a[1]?r(!1):u.child("i/"+h(a,t)+":"+e).remove(function(e){e?i("Error: Firebase synchronization failed: "+e):r(!0)})},function(e){i("Error: Firebase synchronization failed: "+e)})})}function r(e,n){return new RSVP.Promise(function(t,r){u.child("l/"+e).set(n,function(e){e?r("Error: Firebase synchronization failed: "+e):t()})})}function i(e,n){return new RSVP.Promise(function(r,i){null===n?r():u.child("i/"+h(n,t)+":"+e).set(!0,function(e){e?i("Error: Firebase synchronization failed: "+e):r()})})}function o(e){return new RSVP.Promise(function(n,t){u.child("l/"+e).once("value",function(e){n(e.val())},function(e){t("Error: Firebase synchronization failed: "+e)})})}this.set=function(e,t){return a(e),null!==t&&f(t),n(e,t).then(function(n){return n===!0?new RSVP.all([r(e,t),i(e,t)]):new RSVP.Promise(function(e){e()})})},this.get=function(e){return a(e),o(e)},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new v(u,e)};var u=e};n.distance=function(e,n){f(e),f(n);var t=6371,r=c(n[0]-e[0]),i=c(n[1]-e[1]),o=Math.sin(r/2)*Math.sin(r/2)+Math.cos(c(e[0]))*Math.cos(c(n[0]))*Math.sin(i/2)*Math.sin(i/2),u=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return t*u};var t=10,r="0123456789bcdefghjkmnpqrstuvwxyz",i={north:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy",odd:"bc01fg45238967deuvhjyznpkmstqrwx"},east:{even:"bc01fg45238967deuvhjyznpkmstqrwx",odd:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},south:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb",odd:"238967debc01fg45kmstqrwxuvhjyznp"},west:{even:"238967debc01fg45kmstqrwxuvhjyznp",odd:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}},o={north:{even:"prxz",odd:"bcfguvyz"},east:{even:"bcfguvyz",odd:"prxz"},south:{even:"028b",odd:"0145hjnp"},west:{even:"0145hjnp",odd:"028b"}},u=[null,5003.771699005143,625.4714623756429,156.36786559391072,19.54598319923884,4.88649579980971,.6108119749762138],a=function(e){var n;if("string"!=typeof e?n="key must be a string":0===e.length?n="key cannot be the empty string":1+t+e.length>755?n="key is too long to be stored in Firebase":/[\[\].#$\/\u0000-\u001F\u007F]/.test(e)&&(n="key cannot contain any of the following characters: . # $ ] [ /"),"undefined"!=typeof n)throw new Error("Invalid GeoFire key '"+e+"': "+n)},f=function(e){var n;if("[object Array]"!==Object.prototype.toString.call(e))n="location must be an array";else if(2!==e.length)n="expected array of length 2, got length "+e.length;else{var t=e[0],r=e[1];"number"!=typeof t?n="latitude must be a number":-90>t||t>90?n="latitude must be within the range [-90, 90]":"number"!=typeof r?n="longitude must be a number":(-180>r||r>180)&&(n="longitude must be within the range [-180, 180]")}if("undefined"!=typeof n)throw new Error("Invalid GeoFire location '"+e+"': "+n)},s=function(e){var n;if("string"!=typeof e)n="geohash must be a string";else if(0===e.length)n="geohash cannot be the empty string";else for(var t=0,i=e.length;i>t;++t)-1===r.indexOf(e[t])&&(n='geohash cannot contain "'+e[t]+'"');if("undefined"!=typeof n)throw new Error("Invalid GeoFire geohash '"+e+"': "+n)},d=function(e,n){if("object"!=typeof e)throw new Error("query criteria must be an object");if("undefined"==typeof e.center&&"undefined"==typeof e.radius)throw new Error("radius and/or center must be specified");if(n&&("undefined"==typeof e.center||"undefined"==typeof e.radius))throw new Error("query criteria for a new query must contain both a center and a radius");for(var t in e)if(e.hasOwnProperty(t)&&"center"!==t&&"radius"!==t)throw new Error("Unexpected attribute '"+t+"'' found in query criteria");if("undefined"!=typeof e.center&&f(e.center),"undefined"!=typeof e.radius){if("number"!=typeof e.radius)throw new Error("radius must be a number");if(e.radius<0)throw new Error("radius must be greater than or equal to 0")}},c=function(e){if("number"!=typeof e)throw new Error("Error: degrees must be a number");return e*Math.PI/180},h=function(e,n){if(f(e),"undefined"!=typeof n){if("number"!=typeof n)throw new Error("precision must be a number");if(0>=n)throw new Error("precision must be greater than 0");if(n>22)throw new Error("precision cannot be greater than 22");if(Math.round(n)!==n)throw new Error("precision must be an integer")}n=n||t;for(var i={min:-90,max:90},o={min:-180,max:180},u="",a=0,s=0,d=1;u.length<n;){var c=d?e[1]:e[0],h=d?o:i,l=(h.min+h.max)/2;c>l?(a=(a<<1)+1,h.min=l):(a=(a<<1)+0,h.max=l),d=!d,4>s?s++:(s=0,u+=r[a],a=0)}return u},l=function(e,n){if(s(e),-1===["north","south","east","west"].indexOf(n))throw new Error('Error: direction must be one of "north", "south", "east", or "west"');var t=e.charAt(e.length-1),u=e.length%2?"odd":"even",a=e.substring(0,e.length-1);if(-1!==o[n][u].indexOf(t)){if(a.length<=0)return"";a=l(a,n)}return a+r[i[n][u].indexOf(t)]},y=function(e){s(e);var n=[];return n.push(l(e,"north")),n.push(l(e,"south")),n.push(l(e,"east")),n.push(l(e,"west")),""!==n[0]&&(n.push(l(n[0],"east")),n.push(l(n[0],"west"))),""!==n[1]&&(n.push(l(n[1],"east")),n.push(l(n[1],"west"))),n},v=function(r,i){function o(e,n){var t=k[n];w[e].forEach(function(e){"undefined"==typeof t?e(n,null,null):e(n,t.location,t.distanceFromCenter)})}function a(){w.ready.forEach(function(e){e()})}function f(e){b===!1&&g++;var n=e.name().split(":").splice(1).join(":");"undefined"==typeof k[n]&&(k[n]={isInQuery:!1},m.child("l/"+n).on("value",s))}function s(e){var r,i,u=e.name(),f=e.val();k[u].isInQuery===!1?null===f?(m.child("l/"+u).off("value",s),delete k[u]):(r=n.distance(f,E),i=P>=r,k[u]={location:f,distanceFromCenter:r,isInQuery:i,geohash:h(f,t)},i&&o("key_entered",u),g>0&&(g--,b&&0===g&&a())):null===f?(m.child("l/"+u).off("value",s),delete k[u],o("key_exited",u)):(f[0]!==k[u].location[0]||f[1]!==k[u].location[1])&&(r=n.distance(f,E),i=P>=r,k[u]={location:f,distanceFromCenter:r,isInQuery:i,geohash:h(f,t)},i?o("key_moved",u):o("key_exited",u))}function c(){p++,b=p===v.length,b&&0===g&&a()}function l(){for(var e=6;P>u[e];)e-=1;var n=h(E,t).substring(0,e);v=y(n),v.push(n),v=v.filter(function(e,n){return""!==e&&v.indexOf(e)===n});for(var r in x)if(x.hasOwnProperty(r)){var i=v.indexOf(r);-1===i?x[r]=!1:(x[r]=!0,v.splice(i,1))}p=0;for(var o=0,a=v.length;a>o;++o){var s=v[o].substring(0,e),d=s+"~",l=m.child("i").startAt(null,s).endAt(null,d);x[s]=!0,l.on("child_added",f),l.once("value",c)}}this.center=function(){return E},this.radius=function(){return P},this.updateCriteria=function(e){d(e),E=e.center||E,P=e.radius||P;for(var t in k)if(k.hasOwnProperty(t)){var r=k[t];if("undefined"!=typeof r.location){var i=r.isInQuery;r.distanceFromCenter=n.distance(r.location,E),r.isInQuery=r.distanceFromCenter<=P,i&&!r.isInQuery?o("key_exited",t):!i&&r.isInQuery&&o("key_entered",t)}}b=!1,g=0,l()},this.on=function(n,t){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(n))throw new Error('event type must be "ready", "key_entered", "key_exited", or "key_moved"');if("function"!=typeof t)throw new Error("callback must be a function");if(w[n].push(t),"key_entered"===n)for(var r in k)if(k.hasOwnProperty(r)){var i=k[r];i.isInQuery&&t(r,i.location,i.distanceFromCenter)}return"ready"===n&&b&&t(),new e(function(){w[n].splice(w[n].indexOf(t),1)})},this.cancel=function(){w={ready:[],key_entered:[],key_exited:[],key_moved:[]};for(var e in x)x.hasOwnProperty(e)&&(m.child("i").startAt(null,e).endAt(null,e+"~").off("child_added",f),delete x[e]);for(var n in k)k.hasOwnProperty(n)&&(m.child("l/"+n).off("value",s),delete k[n])};var v,p,m=r,w={ready:[],key_entered:[],key_exited:[],key_moved:[]},b=!1,g=0,k={},x={};setInterval(function(){for(var e in x)if(x.hasOwnProperty(e)&&x[e]===!1){m.child("i").startAt(null,e).endAt(null,e+"~").off("child_added",f),delete x[e];for(var n in k)k.hasOwnProperty(n)&&0===k[n].geohash.indexOf(e)&&(m.child("l/"+n).off("value",s),delete k[n])}},1e4),d(i,!0);var E=i.center,P=i.radius;l()};return n}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=GeoFire);